name: CD - Deploy to Development

on:
  workflow_run:
    workflows: ["CI - Build and Push to ECR"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

env:
  ECR_REPOSITORY: frontend-demo
  ECR_REGISTRY: ${{ vars.AWS_DEV_ACCOUNT_ID }}.dkr.ecr.${{ vars.AWS_DEV_ECR_REGION }}.amazonaws.com
  INSTANCE_ID: i-09f9fe068a9daefed
  SERVICE_NAME: frontend
  SSH_USER: ubuntu
  HEALTH_CHECK_FQDN: demo.tdops.net
  IMAGE_TAG: latest

jobs:
  deploy:
    name: Deploy to Development
    runs-on: [self-hosted, dev-nva]
    
    # Only run if CI workflow was successful and triggered by push (not PR), or if manually dispatched
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.event == 'push')
    
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEV_GITHUB_ACTION_ROLE }}
          aws-region: ${{ vars.AWS_DEV_REGION }}

      - name: Get latest image tag
        id: get-tag
        run: |
          echo "image_tag=${{ env.IMAGE_TAG }}" >> $GITHUB_OUTPUT
          echo "full_image=${ECR_REGISTRY}/${ECR_REPOSITORY}:${{ env.IMAGE_TAG }}" >> $GITHUB_OUTPUT

      - name: Get EC2 instance details
        id: get-instance
        run: |
          PRIVATE_IP=$(aws ec2 describe-instances \
            --instance-ids ${{ env.INSTANCE_ID }} \
            --query 'Reservations[0].Instances[0].PrivateIpAddress' \
            --output text \
            --region ${{ vars.AWS_DEV_REGION }})
          echo "private_ip=${PRIVATE_IP}" >> $GITHUB_OUTPUT

      - name: Template service file
        run: |
          # Get API key from SSM Parameter Store
          API_KEY=$(aws ssm get-parameter --name "/inference/api-key" --with-decryption --query 'Parameter.Value' --output text --region ${{ vars.AWS_DEV_REGION }})

          # Create templated service file in workspace
          sed -e "s|{{IMAGE}}|${{ steps.get-tag.outputs.full_image }}|g" \
              -e "s|{{ECR_REGISTRY}}|${{ env.ECR_REGISTRY }}|g" \
              -e "s|{{ECR_REGION}}|${{ vars.AWS_DEV_ECR_REGION }}|g" \
              -e "s|{{API_KEY}}|${API_KEY}|g" \
              deployment/frontend.service.template > frontend.service

      - name: Copy templated service file to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ steps.get-instance.outputs.private_ip }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_EC2_KEY }}
          source: "frontend.service"
          target: "/home/ubuntu/"

      - name: Stop service
        uses: appleboy/ssh-action@v1.0.3
        env:
          SERVICE_NAME: ${{ env.SERVICE_NAME }}
        with:
          host: ${{ steps.get-instance.outputs.private_ip }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_EC2_KEY }}
          envs: SERVICE_NAME
          script: |
            # Stop existing service if it exists
            if systemctl list-units --full -all | grep -Fq "${SERVICE_NAME}.service"; then
              echo "Service ${SERVICE_NAME} exists, stopping it..."
              sudo systemctl stop ${SERVICE_NAME} || true
              sudo systemctl disable ${SERVICE_NAME} || true
            else
              echo "Service ${SERVICE_NAME} does not exist, skipping stop step"
            fi

            # Clean up existing containers
            echo "Cleaning up containers for ${SERVICE_NAME}..."
            sudo docker stop ${SERVICE_NAME} || true
            sudo docker rm ${SERVICE_NAME} || true

      - name: Sleep after stopping service
        run: sleep 10

      - name: Copy service file and reload systemd
        uses: appleboy/ssh-action@v1.0.3
        env:
          SERVICE_NAME: ${{ env.SERVICE_NAME }}
        with:
          host: ${{ steps.get-instance.outputs.private_ip }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_EC2_KEY }}
          envs: SERVICE_NAME
          script: |
            # Copy the templated service file to systemd directory
            sudo cp /home/ubuntu/frontend.service /etc/systemd/system/${SERVICE_NAME}.service

            # Reload systemd
            sudo systemctl daemon-reload
            echo "Systemd daemon reloaded"

      - name: Sleep after copying and reloading
        run: sleep 5

      - name: Start service
        uses: appleboy/ssh-action@v1.0.3
        env:
          SERVICE_NAME: ${{ env.SERVICE_NAME }}
        with:
          host: ${{ steps.get-instance.outputs.private_ip }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_EC2_KEY }}
          envs: SERVICE_NAME
          script: |
            # Enable and start service
            echo "Starting ${SERVICE_NAME} service..."
            sudo systemctl enable ${SERVICE_NAME}
            sudo systemctl start ${SERVICE_NAME}
            sleep 5
            sudo systemctl status ${SERVICE_NAME} --no-pager


      - name: Health check
        uses: Jtalk/url-health-check-action@v4
        with:
          url: https://${{ env.HEALTH_CHECK_FQDN }}
          max-attempts: 10
          retry-delay: 5s
          insecure: true # this is to bypass the missing certificate - should be fixed properly later.

      - name: Deployment summary
        run: |
          echo "### ðŸš€ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** development" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** ${{ env.SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ steps.get-tag.outputs.full_image }}" >> $GITHUB_STEP_SUMMARY
          echo "**SHA:** ${{ github.event.workflow_run.head_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Health Check:** âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service URL:** https://${{ env.HEALTH_CHECK_FQDN }}" >> $GITHUB_STEP_SUMMARY